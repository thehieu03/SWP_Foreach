function cart(t,i){var a=this;this.id=t,this.host=i,this.products=[],this.defaults={gridclass:".table-cart tbody",row:'<tr data-id="">    <td data-field="img"><img class="img-fluid" src=""/></td>    <td data-field="name"><a href=""></a></td>    <td data-field="price" class="text-right money"></td>    <td data-field="quantity"><input type="text" class="form-control number" maxlength="4" value="1"/></td>    <td data-field="subtotal" class="text-right money"></td>    <td data-field="delete"><a class="btn-delete-cart" href="javascript:void(0);"><i class="fa fa-trash"></i></a></td></tr>',rowempty:'<tr><tdcolspan="0"><p class="empty-message">Kh\xf4ng t\xecm thấy dữ liệu !</p></td></tr>',rowtotal:".table-cart tfoot",orderclass:".form-order",empty:'<div class="empty-cart">    <p><img src="https://drive.gianhangvn.com/image/empty-cart.jpg" /></p>    <p class="empty-cart-title" data-lang="pc_empty">Hiện tại, Giỏ h\xe0ng của bạn đang trống</p>    <a class="btn btn-default" title="Tiếp tục mua h\xe0ng" href="/san-pham.html" data-lang="pc_success_continue">H\xe3y tiếp tục mua h\xe0ng →</a></div>'},this.loadData=function(t,i){if(this.products.length>0){t||(t=this.host);var e=$.map(this.products,function(t,i){return{id:t.id,attrid:t.attrid}});new Ajax(t).postData("/api/productcart",{lang:window.language,ids:e},function(t){if(t.length>0){var e=JSON.parse(t);$(a.id).find(a.defaults.gridclass).html("");for(var s=0;s<e.length;s++){$(a.id).find(a.defaults.gridclass).append(a.defaults.row);var r=$(a.id).find(a.defaults.gridclass).find("[data-id]").last(),d=a.setPrice(e[s].id,e[s].price,e[s].attrid),n=e[s].price*d;r.attr("data-id",e[s].id),r.attr("data-attrid",e[s].attrid),r.find("[data-field]").each(function(){var t=$(this).attr("data-field");switch(t){case"img":$(this).find("img").attr("src",e[s][t]);break;case"name":var r=e[s].url,h=e[s][t];parseInt(e[s].attrid)>0&&(r=r+"?id="+e[s].attrid,h=h+"<br/><i>("+e[s].attrname+")</i>"),$(this).find("a").attr("href",r).html(h);break;case"price":$(this).html(formatNumber(e[s][t]));break;case"quantity":$(this).find("input").val(d).on("focusout change",function(t){var i=parseInt($(this).val());if(!i||i<0){showAlertInfoFocus("Số lượng phải lớn hơn 0.",this);return}var e=parseInt($(this).closest("[data-id]").attr("data-id")),s=parseInt($(this).closest("[data-id]").attr("data-attrid")),r=a.setQuantity(e,i,s);$(a.id).find(a.defaults.gridclass).find('[data-id="'+e+'"][data-attrid="'+s+'"]').find('[data-field="subtotal"]').html(formatNumber(r*i)),a.setShippingFee(),a.showTotal()}).on("keypress",function(t){(13==t.keyCode||13==t.which)&&$(this).trigger("focusout")}).number(!0),$(this).hasClass("spinner")&&($(this).find('input[type="text"]').on("change paste keyup",function(){var t=parseInt($(this).val());isNaN(t)||t<parseInt($(this).attr("min"))?($(this).val($(this).attr("min")),$(this).change()):t>parseInt($(this).attr("max"))&&($(this).val($(this).attr("max")),$(this).change())}),$(this).find(".btn:last-child").on("click touch",function(){var t=$(this),i=t.closest(".spinner").find("input");void 0==i.attr("max")||parseInt(i.val())<parseInt(i.attr("max"))?(i.val(parseInt(i.val(),10)+1),i.change()):t.next("disabled",!0)}),$(this).find(".btn:first-child").on("click touch",function(){var t=$(this),i=t.closest(".spinner").find("input");void 0==i.attr("min")||parseInt(i.val())>parseInt(i.attr("min"))?(i.val(parseInt(i.val(),10)-1),i.change()):t.prev("disabled",!0)}));break;case"subtotal":$(this).html(formatNumber(n));break;case"delete":$(this).find("a").on("click touch",function(){var t=this;showAlertQuestion("vi"==window.language?"Bạn c\xf3 muốn x\xf3a sản phẩm ra khỏi giỏ h\xe0ng hay kh\xf4ng?":ObjLangs.msg_cart_delete,function(e){if(e){var s=$(t).closest("[data-id]"),r=parseInt(s.attr("data-id")),d=parseInt(s.attr("data-attrid"));r>0&&(a.deleteProduct(r,d),a.setShippingFee(),a.showTotal(),s.remove(),i&&i(a.countProducts(),a.getSubtotal()))}})})}})}a.showTotal(),a.setLocalStorage(),a.loadOrderInfo()}else a.deleteAll(),a.showEmpty()})}else a.showEmpty()},this.showTotal=function(){var t=this.getSubtotal(),i=parseInt($(this.id).find(this.defaults.rowtotal).find('[data-field="shipping"]').attr("data-value"));(!i||i<0)&&(i=0),$(this.id).find(this.defaults.rowtotal).find('[data-field="subtotal"]').html(formatNumber(t)),$(this.id).find(this.defaults.rowtotal).find('[data-field="total"]').html(formatNumber(t+i))},this.countProducts=function(){return this.products?this.products.length:0},this.getSubtotal=function(){var t=0;if(this.products&&this.products.length>0)for(var i=0;i<this.products.length;i++)this.products[i].price>0&&(t+=this.products[i].price*this.products[i].quantity);return t},this.setPrice=function(t,i,a){a||(a=0);var e=1;if(this.products&&this.products.length>0){for(var s=0;s<this.products.length;s++)if(this.products[s].id==t&&this.products[s].attrid==a){this.products[s].price=parseInt(i),e=this.products[s].quantity,this.setLocalStorage();break}}return e},this.setQuantity=function(t,i,a){a||(a=0);var e=0;if(this.products&&this.products.length>0){for(var s=0;s<this.products.length;s++)if(this.products[s].id==t&&this.products[s].attrid==a){this.products[s].quantity=parseInt(i),e=this.products[s].price,this.setLocalStorage();break}}return e},this.addProduct=function(t,i,a,e){e||(e=0);for(var s=!1,r=0;r<this.products.length;r++)if(this.products[r].id==t&&this.products[r].attrid==e){this.products[r].quantity+=i,s=!0;break}if(!s){var d=parseInt(a);(!d||d<0)&&(d=0),this.products.push({id:t,quantity:i,price:d,attrid:e})}this.setLocalStorage()},this.deleteProduct=function(t,i){i||(i=0);var a=this.products.findIndex(a=>a.id==t&&a.attrid==i);a>-1&&this.products.splice(a,1),this.setLocalStorage(),0==this.products.length&&this.loadData()},this.deleteAll=function(){this.products=[],this.setLocalStorage()},this.saveData=function(){var t=[];if(this.products&&this.products.length>0)for(var i=0;i<this.products.length;i++)t.push({id:this.products[i].id,attrid:this.products[i].attrid,quantity:this.products[i].quantity});if(0==t.length){showAlertInfo(ObjLangs.msg_cart_empty);return}var e={lang:window.language,products:JSON.stringify(t)},s=!0;if($(this.id).find(this.defaults.orderclass).find("[data-field]").each(function(){if(s){var t,i=$(this).attr("data-field"),r=1==parseInt($(this).attr("data-required"));switch(i){case"ReceiveCityId":case"ReceiveDistrictId":if(t=parseInt($(this).val()),r&&(!t||t<0)){a.showAlertSelectEmpty(this),s=!1;return}e[i]=t;break;case"PaymentMethodId":t=parseInt($(this).find("input:checked").val()),e[i]=t;break;case"captcha":if(t=$(this).val().trim(),r&&0==t.length){a.showAlertInputEmpty(this),s=!1;return}e.uid=getUIDCookie(),e.captchacode=$(this).closest(".captcha").find("img").attr("data-id"),e[i]=t;break;default:if(t=$(this).val().trim(),r&&0==t.length){a.showAlertInputEmpty(this),s=!1;return}e[i]=t}}}),s){var r=new Ajax(this.host);$("body").trigger("startLoading"),r.postData("/page/order",e,function(t){if($("body").trigger("stopLoading"),t.status>0){var i=parseInt(t.data);if(i>0){a.deleteAll(),a.setLocalStorageOrderInfo(e);var s=$(a.id).attr("data-url");s&&0!=s.length||(s="/don-hang-thanh-cong.html","vi"==window.language||(s="/"+window.language+s)),window.location.href=s+"?order="+i}else showAlertInfo(ObjLangs.msg_cart_unsuccess)}else showAlertWarning(t.message),t.data&&t.data.captcha&&t.data.captcha.length>0&&$(a.id).find('.captcha img[data-name="order"]').each(function(){setCaptchaImage(this,t.data.captcha,!1)})})}},this.loadShippingFee=function(t,i){if(window.shippingFee){var e=a.getShippingFee(t,i);$(a.id).find(a.defaults.rowtotal).find('[data-field="shipping"]').attr("data-value",e).html(formatNumber(e)),a.showTotal()}else new Ajax(window.webUrl).getData("/api/shipping",function(e){if(e.status>0){window.shippingFee=e.data;var s=a.getShippingFee(t,i);$(a.id).find(a.defaults.rowtotal).find('[data-field="shipping"]').attr("data-value",s).html(formatNumber(s)),a.showTotal()}})},this.setShippingFee=function(){var t=parseInt($(this.id).find(this.defaults.orderclass).find('select[data-field="ReceiveCityId"] option:selected').val()),i=parseInt($(this.id).find(this.defaults.orderclass).find('select[data-field="ReceiveDistrictId"] option:selected').val());this.loadShippingFee(t,i)},this.getShippingFee=function(t,i){var e=0,s=a.getSubtotal();if(window.shippingFee&&window.shippingFee.length>0){if(t>0&&i>0){for(var r,d,n,h,l=0;l<window.shippingFee.length;l++)if(r=parseInt(window.shippingFee[l].CityId),d=parseInt(window.shippingFee[l].DistrictId),n=parseInt(window.shippingFee[l].FromMoney),h=parseInt(window.shippingFee[l].ToMoney),t==r&&i==d&&s>=n&&(s<=h||-1==h)){e=parseInt(window.shippingFee[l].Price);break}}if(t>0&&0==e){for(var l=0;l<window.shippingFee.length;l++)if(r=parseInt(window.shippingFee[l].CityId),d=parseInt(window.shippingFee[l].DistrictId),n=parseInt(window.shippingFee[l].FromMoney),h=parseInt(window.shippingFee[l].ToMoney),t==r&&-1==d&&s>=n&&(s<=h||-1==h)){e=parseInt(window.shippingFee[l].Price);break}}if(0==e){for(var l=0;l<window.shippingFee.length;l++)if(r=parseInt(window.shippingFee[l].CityId),d=parseInt(window.shippingFee[l].DistrictId),n=parseInt(window.shippingFee[l].FromMoney),h=parseInt(window.shippingFee[l].ToMoney),(-1==r||64==r)&&-1==d&&s>=n&&(s<=h||-1==h)){e=parseInt(window.shippingFee[l].Price);break}}}return e},this.loadLocalStorage=function(){var t=getCache("cart");t&&t.length>0&&(this.products=JSON.parse(t)),this.products||(this.products=[])},this.setLocalStorage=function(){addCache("cart",JSON.stringify(this.products))},this.loadLocalStorage(),this.setLocalStorageOrderInfo=function(t){var i={};for(var a in t)switch(a){case"ReceiveName":case"ReceivePhone":case"ReceiveEmail":case"ReceiveAddress":case"CompanyTax":case"CompanyName":case"CompanyAddress":case"ReceiveCityId":case"ReceiveDistrictId":i[a.toLowerCase()]=t[a]}addCache("order",JSON.stringify(i))},this.loadOrderInfo=function(){var t=getCache("order");t&&t.length>0&&(t=JSON.parse(t),$(a.id).find(a.defaults.orderclass).find("[data-field]").each(function(){var i=$(this).attr("data-field"),a=t[i.toLowerCase()];switch(a||(a=""),i){case"ReceiveName":case"ReceivePhone":case"ReceiveEmail":case"ReceiveAddress":case"CompanyTax":case"CompanyName":case"CompanyAddress":$(this).val(a);break;case"ReceiveCityId":case"ReceiveDistrictId":$(this).val(parseInt(a)).trigger("change")}}))},this.showAlertInputEmpty=function(t){"vi"==window.language?showAlertInfoFocus(ObjLangs.msg_invalid+$(t).attr("data-title"),t):showAlertInfoFocus(ObjLangs.msg_invalid+ObjLangs[$(t).attr("data-lang")],t)},this.showAlertSelectEmpty=function(t){"vi"==window.language?showAlertInfoFocus(ObjLangs.msg_invalid_select+$(t).attr("data-title"),t):showAlertInfoFocus(ObjLangs.msg_invalid_select+ObjLangs[$(t).attr("data-lang")],t)},this.showEmpty=function(){$(a.id).html(a.defaults.empty),$(a.id).find("*[data-lang]").each(function(){this.tagName.toLowerCase();var t=ObjLangs[$(this).attr("data-lang")];$(this).html(t)})}}function productAttribute(t,i,a){var e=this;this.id=t,this.attributes=[],this.productAttributes=[],this.defaultProductAttributeId=-1,this.owlBigImages=i,this.owlThumbImages=a,this.carouselFilter=null,this.defaults={attributes:'<div class="product-option attribute" data-id="{0}"><span class="product-label">{1}</span>{2}</div>',attributelist:'<div class="product-option-list">{0}</div>',attributeItem:'<div class="product-option-item attribute-value" data-parent="{0}" data-id="{1}"><span class="value">{2}</span></div>'},this.compareArrays=function(t,i){return 0==$(t).not(i).length&&0==$(i).not(t).length},this.loadData=function(){for(var t,i="",a=0;a<this.attributes.length;a++){t="";for(var s=JSON.parse(this.attributes[a].value),r=0;r<s.length;r++)t+=this.defaults.attributeItem.format(s[r].parent,s[r].id,s[r].name);t=this.defaults.attributelist.format(t),i+=this.defaults.attributes.format(this.attributes[a].id,this.attributes[a].name,t)}$(this.id).html(i),$(this.id).find(".attribute-value").on("click touch",function(){var t=parseInt($(this).attr("data-id")),i=parseInt($(this).attr("data-parent"));$(e.id).find('.attribute[data-id="'+i+'"]').find(".attribute-value").removeClass("disable active"),$(this).addClass("active"),$(e.id).find(".attribute[data-id]").each(function(){if(parseInt($(this).attr("data-id"))!=i){var a=!0;$(this).find(".attribute-value").each(function(){var i=parseInt($(this).attr("data-id"));e.existedAttributeValues([t,i])?$(this).removeClass("disable"):$(this).addClass("disable").removeClass("active"),$(this).hasClass("active")&&(a=!1)}),a&&$(this).find(".attribute-value:not(.disable)").first().addClass("active")}}),e.showData()})},this.showData=function(){var t=".main",i=this.getActiveProductAttribute();if(null!=i){var a=$(this.id).attr("data-target-price"),e=parseInt(i.status),s=parseInt(i.price),r=parseInt(i.oldprice),d=parseInt(i.discount),n=$(a).attr("data-symbol");1==e?($(a).find(".price").html(formatNumber(s)+" "+n),r>0?($(a).find(".old-price").removeClass("none").html(formatNumber(r)+" "+n),$(a).find(".sale-off").removeClass("none").html("-"+d+"%")):($(a).find(".old-price").addClass("none"),$(a).find(".sale-off").addClass("none"))):($(a).find(".price").html(i.pricetext),$(a).find(".old-price").addClass("none"),$(a).find(".sale-off").addClass("none")),$(".quantity-value").html(formatNumber(parseInt(i.quantity)));var h=getCurrentUrl();i.id!=this.defaultProductAttributeId&&(h=h+"?id="+i.id),window.history.replaceState(null,null,h),t=".attribute-"+i.id}this.setCarouselFilter(t)},this.setDisableAttributeValueOther=function(t,i){$(e.id).find(".attribute[data-id]").each(function(){parseInt($(this).attr("data-id"))!=t&&$(this).find(".attribute-value").each(function(){var t=parseInt($(this).attr("data-id"));e.existedAttributeValues([i,t])||$(this).addClass("disable").removeClass("active")})})},this.getProductAttributeById=function(t){if(this.productAttributes&&this.productAttributes.length>0){for(var i=0;i<this.productAttributes.length;i++)if(parseInt(this.productAttributes[i].id)==t)return this.productAttributes[i]}return null},this.getActiveProductAttribute=function(){var t=this.getActiveAttributeValues();if(t.length>0&&this.productAttributes&&this.productAttributes.length>0)for(var i=0;i<this.productAttributes.length;i++){var a=JSON.parse(this.productAttributes[i].attributevalues);if(e.compareArrays(a,t))return this.productAttributes[i]}return null},this.getActiveProductAttributeId=function(){var t=this.getActiveProductAttribute();return t?parseInt(t.id):0},this.existedAttributeValues=function(t){if(this.productAttributes&&this.productAttributes.length>0)for(var i=0;i<this.productAttributes.length;i++){var a=JSON.parse(this.productAttributes[i].attributevalues);if(e.compareArrays(a,t))return!0}return!1},this.resetAttributeValues=function(){$(this.id).find(".attribute-value").removeClass("disable active")},this.setActiveAttributeValues=function(t){this.resetAttributeValues();var i=this.getProductAttributeById(parseInt(t));if(null!=i){for(var a=JSON.parse(i.attributevalues),s=0;s<a.length;s++)$(this.id).find('.attribute-value[data-id="'+a[s]+'"]').addClass("active");$(e.id).find(".attribute[data-id]").each(function(){var t=parseInt($(this).attr("data-id")),i=parseInt($(this).find(".attribute-value.active").attr("data-id"));e.setDisableAttributeValueOther(t,i)})}e.showData()},this.setActiveDefaultAttributeValues=function(){this.setActiveAttributeValues(this.defaultProductAttributeId)},this.getActiveAttributeValues=function(){var t=[];return $(e.id).find(".attribute-value.active").each(function(){t.push(parseInt($(this).attr("data-id")))}),t},this.setTextAttributes=function(){$(e.id).find(".attribute").each(function(){var t="";$(this).find(".attribute-value.active").each(function(){t=$(this).find(".value>span").text()}),$(this).find(".label .value").html(t)})},this.setCarouselFilter=function(t){this.owlBigImages&&this.owlBigImages.owlCarouselFilter(t),this.owlThumbImages&&this.owlThumbImages.owlCarouselFilter(t),".main"!=t&&(this.owlBigImages&&0==this.owlBigImages.data("owl.carousel")._items.length&&this.owlBigImages.owlCarouselFilter(".main"),this.owlThumbImages&&0==this.owlThumbImages.data("owl.carousel")._items.length&&this.owlThumbImages.owlCarouselFilter(".main")),null!=this.carouselFilter&&this.carouselFilter(t)},this.init=function(t,i){if(this.attributes=t,this.productAttributes=i,this.productAttributes&&this.productAttributes.length>0){for(var a=0;a<this.productAttributes.length;a++)if(1==parseInt(this.productAttributes[a].isdefault)){this.defaultProductAttributeId=parseInt(this.productAttributes[a].id);break}}}}